(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e)+e),t=e=>{for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e};window.utils={getRandom:e,getRandomFrom:t=>t[e(0,t.length-1)],getRandomArray:t=>t.slice(e(0,t.length/2),e(t.length/2+1,t.length-1)),invokeIfKeyIs:(e,t)=>o=>o.key===e&&t(o),shuffleArray:t,getTruncatedArray:(e,o)=>t(e).slice(0,o),removeArray:e=>e.forEach((e=>e.remove()))}})(),window.debounce=function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e="GET",t="POST",o="https://21.javascript.pages.academy/keksobooking/data",n="https://21.javascript.pages.academy/keksobooking",r=(e,t,o,n,r)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(function(){200===a.status?e(a.response):t("Произошла ошибка "+a.status+a.statusText)})),a.addEventListener("error",(function(){t("Произошла ошибка соединения")})),a.addEventListener("timeout",(function(){t("Запрос не успел выполниться за 1000 мс")})),a.timeout=1e3,a.open(o,n),a.send(r)};window.backend={download:(t,n)=>r(t,n,e,o),upload:(e,o,a)=>r(e,o,t,n,a)}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o=o=>{const n=document.createDocumentFragment();let r="";r="success"===o?e.cloneNode(!0):t.cloneNode(!0),n.appendChild(r),document.querySelector("main").appendChild(n)},n=()=>{document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("click",n),document.removeEventListener("keydown",r)},r=window.utils.invokeIfKeyIs("Escape",n);window.messageHandler={onDownloadError:e=>{o("error"),document.querySelector(".error__message").textContent=e,document.addEventListener("click",n),document.addEventListener("keydown",r)},show:e=>{o(""+e),document.addEventListener("click",n),document.addEventListener("keydown",r),document.querySelector(".error__button")&&document.querySelector(".error__button").addEventListener("click",n)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=Array.from(t.querySelectorAll(".ad-form__element")),n=Array.from(document.querySelectorAll(".map__filter")),r=Array.from(document.querySelectorAll(".map__checkbox")),a=document.querySelector(".map__pin--main"),c=(e,t)=>{e.forEach((function(e){e.disabled=!t}))},d=()=>{e.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),document.querySelector(".map__pin:not(.map__pin--main)")&&c(n,!0),c(o,!0),c(r,!0),a.removeEventListener("mousedown",d)};window.pageMode={activate:d,deactivate:()=>{c(o,!1),c(n,!1),c(r,!1),e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),window.pinMove.setAddress()}}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t={wifi:"popup__feature--wifi",dishwasher:"popup__feature--dishwasher",parking:"popup__feature--parking",washer:"popup__feature--washer",elevator:"popup__feature--elevator",conditioner:"popup__feature--conditioner"},o=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector("#card").content.querySelector(".map__card"),r=document.querySelector(".map"),a=document.querySelector(".map__filters-container"),c=document.querySelector(".map__pins"),d=(e,t,o,n)=>{void 0!==n?e.querySelector(t)[o]=n:e.querySelector(t).style.display="none"},i=e=>{const t=o.cloneNode(!0);return t.style=`top: ${e.location.y+t.offsetHeight/2}px; left: ${e.location.x+t.offsetWidth/2}px`,d(t,"img","src",""+e.author.avatar),d(t,"img","alt",""+e.offer.title),t},s=o=>{const r=n.cloneNode(!0);return window.utils.removeArray(Array.from(r.querySelectorAll(".popup__feature"))),r.querySelector(".popup__photo").remove(),d(r,".popup__avatar","src",""+o.author.avatar),d(r,".popup__title","textContent",""+o.offer.title),d(r,".popup__text--address","textContent",""+o.offer.address),d(r,".popup__text--price","textContent",o.offer.price+" руб./ночь"),d(r,".popup__type","textContent",""+e[o.offer.type]),d(r,".popup__text--capacity","textContent",`Количество комнат: ${o.offer.rooms}; Максимальное количество гостей: ${o.offer.guests}`),d(r,".popup__text--time","textContent",`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`),((e,o)=>{const n=o.querySelector(".popup__features"),r=Array.from(e.offer.features),a=document.createDocumentFragment();for(let e=0;e<r.length;e++){const o=document.createElement("li");o.classList.add("popup__feature",""+t[r[e]]),a.appendChild(o)}n.appendChild(a)})(o,r),d(r,".popup__description","textContent",""+o.offer.description),((e,t)=>{const o=Array.from(e.offer.photos),n=document.createDocumentFragment();for(let t=0;t<o.length;t++){const o=document.createElement("img");o.src=""+e.offer.photos[t],o.width="45",o.height="40",o.alt="Фотография жилья",o.classList.add("popup__photo"),n.appendChild(o)}t.querySelector(".popup__photos").appendChild(n)})(o,r),r},u=e=>{const t=document.createDocumentFragment();window.utils.getTruncatedArray(e,5).map(i).forEach((e=>t.appendChild(e))),c.appendChild(t)};window.elementsRender={pin:i,card:s,allPins:u,selectedCard:(e,t)=>{const o=document.createDocumentFragment();e.forEach((e=>{t===e.offer.title&&o.appendChild(s(e))})),r.insertBefore(o,a)},filteredPins:e=>{window.utils.removeArray(Array.from(document.querySelectorAll(".map__pin:not(.map__pin--main)"))),u(e)}}})(),(()=>{const e="Значение меньше минимума символов на ",t="Превышение максимума символов на ",o="Цена меньше минимума на ",n="Цена превышает максимум на ",r={BUNGALOW:"0",FLAT:"1 000",HOUSE:"5 000",PALACE:"10 000"},a=document.querySelector(".ad-form"),c=a.querySelector("[name='rooms']"),d=a.querySelector("[name='capacity']"),i=a.querySelector("[name='title']"),s=a.querySelector("[name='type']"),u=a.querySelector("[name='price']"),l=(e,t,o,n,r,a)=>{t<o?e.setCustomValidity(r+(o-t)):t>n?e.setCustomValidity(a+(t-n)):e.setCustomValidity(""),e.reportValidity()},p=()=>parseInt(r[s.value.toUpperCase()].replace(" ",""),10),m=e=>e<=3?Array.from({length:e},((e,t)=>t+1)):[0];window.formValidation={onTitleEnter:()=>l(i,i.value.length,30,100,e,t),onTypeChange:()=>{u.placeholder=r[s.value.toUpperCase()]},onPriceEnter:()=>l(u,u.value,p(),1e6,o,n),getMinPrice:p,onCheckInOutChange:(e,t)=>{t.value=e.value},onRoomsOrGuestsChange:()=>{var e,t;e=parseInt(c.options[c.selectedIndex].value,10),t=parseInt(d.options[d.selectedIndex].value,10),m(e).includes(0)&&0!==t?d.setCustomValidity("Данное помещение не преднозначено для гостей"):m(e).includes(t)?d.setCustomValidity(""):d.setCustomValidity("Максимально возможное количество гостей в данном помещении: "+e),d.reportValidity()}}})(),(()=>{const e=document.querySelector(".map"),t=e.getBoundingClientRect().x,o=t+32.5,n={MIN:t,MAX:t+e.offsetWidth},r=document.querySelector(".map__pin--main"),a=document.querySelector(".ad-form").querySelector("[name='address']"),c=(e,t,o,n,a,c=0)=>{r.style[t]=e<o?o-c+"px":e>n?n-c+"px":a+"px"},d=()=>{const e=Math.round(r.offsetLeft+32.5),t=r.offsetTop+88;a.value=`${e}, ${t}`};window.pinMove={move:e=>{e.preventDefault();const t={x:e.clientX,y:e.pageY},a=e=>{e.preventDefault();const a=t.x-e.clientX,i=t.y-e.pageY;t.x=e.clientX,t.y=e.pageY;const s={x:r.offsetLeft-a,y:r.offsetTop-i};c(t.x,"left",n.MIN,n.MAX,s.x,o),c(t.y,"top",130,630,s.y),d()},i=e=>{e.preventDefault(),d(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)},setAddress:d}})(),(()=>{const e=document.querySelector("[name='housing-type']"),t=document.querySelector("[name='housing-price']"),o=document.querySelector("[name='housing-rooms']"),n=document.querySelector("[name='housing-guests']");window.filterAdverts={list:()=>{let r=[];return window.advertsList.forEach((a=>{(r=>{const a=t.value,c=e.value,d=parseInt(o.value,10),i=parseInt(n.value,10),s=Array.from(document.querySelectorAll("[name='features']:checked"));return(r.offer.type===c||"any"===e.value)&&(r.offer.rooms===d||"any"===o.value)&&(r.offer.guests===i||"any"===n.value)&&(((e,t)=>"low"===t&&e.offer.price<1e4||"middle"===t&&e.offer.price>=1e4&&e.offer.price<=5e4||"high"===t&&e.offer.price>5e4)(r,a)||"any"===t.value)&&((e,t)=>{let o=!0;const n=Array.from(e.offer.features);return t.forEach((e=>{n.includes(e.value)||(o=!1)})),o})(r,s)})(a)&&r.push(a)})),r}}})(),(()=>{const e="Enter",t=document.querySelector(".ad-form"),o=document.querySelector(".map__pin--main"),n=t.querySelector("[name='title']"),r=t.querySelector("[name='type']"),a=t.querySelector("[name='price']"),c=t.querySelector("[name='rooms']"),d=t.querySelector("[name='capacity']"),i=t.querySelector("[name='timein']"),s=t.querySelector("[name='timeout']"),u=t.querySelector(".ad-form__reset"),l=document.querySelector("[name='housing-type']"),p=document.querySelector("[name='housing-price']"),m=document.querySelector("[name='housing-rooms']"),f=document.querySelector("[name='housing-guests']"),y=Array.from(document.querySelectorAll("[name='features']")),w=document.querySelector(".map__pins"),v=()=>{t.reset(),window.messageHandler.show("success"),window.pageMode.deactivate()},h=()=>{window.messageHandler.show("error")},_=window.debounce((function(){document.querySelector(".map__card")&&window.cardPopup.close();const e=window.filterAdverts.list();window.elementsRender.filteredPins(e)}));o.addEventListener("mousedown",(function(e){return 0===e.button&&window.pageMode.activate()})),o.addEventListener("keydown",window.utils.invokeIfKeyIs(e,window.pageMode.activate)),window.pageMode.deactivate(),window.backend.download((e=>{window.elementsRender.allPins(e),window.advertsList=e}),window.messageHandler.onDownloadError),o.addEventListener("mousedown",(function(e){return window.pinMove.move(e)})),w.addEventListener("click",(function(e){const t=e.target,o=t.parentNode;o.classList.contains("map__pin")&&!o.classList.contains("map__pin--main")&&(e.preventDefault(),window.cardPopup.close(),window.cardPopup.open(t.alt))})),w.addEventListener("keydown",(function(t){const o=t.target;t.key!==e||o.classList.contains("map__pin--main")||(t.preventDefault(),window.cardPopup.close(),window.cardPopup.open(o.querySelector("img").alt))}),!0),n.addEventListener("input",window.formValidation.onTitleEnter),r.addEventListener("change",window.formValidation.onTypeChange),a.addEventListener("input",window.formValidation.onPriceEnter),i.addEventListener("change",(function(){return window.formValidation.onCheckInOutChange(i,s)})),s.addEventListener("change",(function(){return window.formValidation.onCheckInOutChange(s,i)})),d.addEventListener("change",window.formValidation.onRoomsOrGuestsChange),c.addEventListener("change",window.formValidation.onRoomsOrGuestsChange),t.addEventListener("submit",(function(e){const o=new FormData(t);window.backend.upload(v,h,o),e.preventDefault()})),u.addEventListener("click",(function(){t.reset()})),l.addEventListener("change",_),p.addEventListener("change",_),m.addEventListener("change",_),f.addEventListener("change",_),y.forEach((e=>e.addEventListener("change",_)))})(),(()=>{const e="Escape",t=()=>{const o=document.querySelector(".map__card");o&&o.remove(),document.removeEventListener("keydown",(function(){return window.utils.invokeIfKeyIs(e,t)}))};window.cardPopup={open:o=>{window.elementsRender.selectedCard(Array.from(window.advertsList),o),document.addEventListener("keydown",window.utils.invokeIfKeyIs(e,t)),document.querySelector(".popup__close").addEventListener("click",t)},close:t}})()})();